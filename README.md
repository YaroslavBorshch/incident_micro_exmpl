# Incidents API

Микросервис для учёта и управления инцидентами. В ТЗ вычитал фразу "займет до 30 минут" поэтому за основу выбрал более простую архитектуру - луковую. По логике работы выглядит примерно так:
- **презентативный слой:** апи-роуты (инцедент)
- **слой приложения:** основная логика репозиторий/сервис
- **доменный слой:** модели и схемы
- **инфраструктура:** кэш/мидлваре
- **кор:** настройка + бд

## 
Добавил проверку в хедер по x-access-key, не писал как авторизацию, а требую при каждом запросе

текущий ключ просто "key"

хотя в таком подходе более правильно было бы использовать HMAC

Так же использую Енамы и их бы по-хорошему использовать и в бд, но пока проверка только на уровне кода, а в бд обычная строка

По описанию добавил заглушку для тг и кафки, по идее в тг будет хендлер, который по новым сообщениям тригерится и публикует сообщение в кафку, а здесь обращение будет не по апи, а по кафка-подписчику.

## Технологии

- FastAPI
- PostgreSQL (asyncpg)
- Redis (кэширование)
- Alembic (миграции)
- Docker & Docker Compose

## Быстрый старт

### Через Docker Compose (рекомендуется)

```bash
make run
```

Или вручную:

```bash
docker-compose up -d --build
```

После запуска API будет доступен на `http://localhost:3003`

- Swagger UI: http://localhost:3003/docs
- Health Check: http://localhost:3003/health

### Локальная установка

1. Установите зависимости через Poetry:

```bash
poetry install
```

2. Запустите PostgreSQL и Redis (можно через docker-compose, только БД):

```bash
docker-compose up -d postgres redis
```

3. Создайте `.env` скопировать из .env.exanple

4. Примените миграции:

```bash
poetry run alembic upgrade head
```

5. Запустите сервер:

```bash
poetry run uvicorn src.main:app --reload --port 3003
```

## Использование

Все эндпоинты требуют заголовок `X-Access-Key` для аутентификации. Значение по умолчанию: `key` (можно изменить через переменную окружения `X_ACCESS_KEY`).

Основные эндпоинты:

- `POST /incidents/` - создать инцидент
- `GET /incidents/` - получить список инцидентов (с фильтрацией по статусу и источнику)
- `GET /incidents/{id}` - получить инцидент по ID
- `PATCH /incidents/{id}/status` - обновить статус инцидента

Полная документация доступна в Swagger UI после запуска.

## Полезные команды

```bash
make up       # Запустить контейнеры
make down     # Остановить контейнеры
make logs     # Просмотр логов
make clean    # Остановить и удалить всё (включая данные БД)
make format   # Форматировать код
make lint     # Проверить код
```

## Структура проекта

```
src/
├── api/              # Роутеры и эндпоинты
├── core/             # Конфигурация и БД
├── domain/           # Модели и схемы
├── infrastructure/   # Middleware, кэш, безопасность
└── services/         # Бизнес-логика
```

